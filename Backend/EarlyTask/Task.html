<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<style>
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        height: 100vh;
    }
    #users {
        border: 1px solid;
        background: red;
        text-align: center;
        border-radius: 20px;
    }
    #innerusers {
        background: blue;
        margin: 20px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 10px;
    }
    #authArea {
        display: flex;
        flex-direction: column;
        border: 5px solid;
        border-radius: 30px;
        padding: 30px;
        gap: 10px;
    }
    #curuser {
        text-align: center;
    }
    #taskArea {
        display: none;
        flex-direction: column;
        border: 1px solid;
        padding: 10px;
        border-radius: 20px;
        gap: 10px;
    }
    #tasks {
        background: red;
    }
    #innertasks {
        background: blue;
    }
    .hidden {
        display: none;
    }
    #tasktitle {
        display: none;
    }
</style>
<body>
    <div id="authArea">
    <input id="namee">
    <input id="passs">
    <button onclick="LoginUser()">Login</button>
    <input id="name">
    <input id="pass">
    <button onclick="CreateUser()">Register</button>
    <p class="result"></p>
    <button onclick="ShowUser()">Show Users</button>
    <button onclick="ClearUser()">Clear Users</button>
    <div id="users"></div>
    </div>
    <div id="taskArea">
    <p id="curuser"></p>
    <input id="tit">
    <input id="des">
    <button onclick="CreateTask()">Create Task</button>
    <button onclick="ShowTask()">Show Task</button>
    <button onclick="EditTaskTitle()">Edit Task</button>
    <p id="tasks"></p>
    <p class="result"></p>
    </div>
    <script>
        let curUser = null;
        const n = document.getElementById("name");
        const p = document.getElementById("pass");
        const nn = document.getElementById("namee");
        const pp = document.getElementById("passs");
        const t = document.getElementById("tit");
        const d = document.getElementById("des");
        async function CreateUser() {
            try {
                const response = await axios.post(`http://localhost:5112/api/task/register`, {
                Name: n.value,
                Pass: p.value              
            })
            msg(response.data.msg);
            } catch (error) {
                msg(error.response.data.msg);
            }
        }
        function LoginUser() {
            axios.post(`http://localhost:5112/api/task/login`, {
                Name: nn.value,
                Pass: pp.value
            })
            .then(res => {
            curUser = res.data;
            document.getElementById("curuser").textContent = curUser.name;
            document.getElementById("authArea").style.display = "none";
            document.getElementById("taskArea").style.display = "flex";
            })
            .catch(err => {
                msg(err.response.data.msg);
            })
        }
        async function CreateTask() {
            try {
                const response = await axios.post(`http://localhost:5112/api/task/task/${curUser.name}`, {
                    Title: t.value,
                    Description: d.value
                })
                msg(response.data.msg);
            } catch (error) {
                msg(error.response.data.msg);
            }
        }
        function ShowTask() {
            axios.get(`http://localhost:5112/api/task/showtask/${curUser.name}`)
            .then(res => {
                const tasks = res.data;
                tasks.sort((a, b) => new Date(a.date) - new Date(b.date));
                const container = document.getElementById("tasks");
                container.innerHTML = "";
                tasks.forEach(t => {
                    const tdiv = document.createElement("div");
                    tdiv.id = "innertasks";
                    tdiv.innerHTML = `<p>${t.title} | ${t.description} (${t.status}) - ${t.date}</p>
                    <button onclick="this.nextElementSibling.classList.toggle('hidden')">:</button>
                    <div class="menu hidden">
                        <button onclick="this.parentElement.querySelector('.tasktitle').classList.toggle('hidden')">Title</button>
                        <input class="tasktitle hidden" onkeydown="if(event.key === 'Enter'){ETT('${t.title}', this.value)}">
                        <button onclick="this.parentElement.querySelector('.taskdesc').classList.toggle('hidden')">Desc</button>
                        <input class="taskdesc hidden" onkeydown="if(event.key === 'Enter'){ETD('${t.title}', this.value)}">
                        <button onclick="this.parentElement.querySelector('.taskstat').classList.toggle('hidden')">Stat</button>
                        <div class="taskstat hidden">
                        To Do<input type="checkbox" class="todo" onchange="ETS('${t.title}', 'To Do')">
                        Ongoing<input type="checkbox" class="ongoing" onchange="ETS('${t.title}', 'Ongoing')">
                        Done<input type="checkbox" class="done" onchange="ETS('${t.title}', 'Done')">
                        </div>
                    </div>
                    `;
                    container.appendChild(tdiv);
                });
            })
            .catch(err => {
                msg(err.response.data.msg);
            })
        }
        async function ETT(tname, tvalue) {
            await axios.post(`http://localhost:5112/api/task/edittasktitle/${curUser.name}/${tname}`, {
                Title: tvalue
            })
            ShowTask();
        }
        async function ETD(tname, tvalue) {
            await axios.post(`http://localhost:5112/api/task/edittaskdesc/${curUser.name}/${tname}`, {
                Description: tvalue
            })
            ShowTask();
        }
        window.ETS = async function ETS(tname, tvalue) {
            await axios.post(`http://localhost:5112/api/task/edittaskstat/${curUser.name}/${tname}`, {
                Status: tvalue
            })
            ShowTask();
        }
        function ShowUser() {
            const container = document.getElementById("users");
            container.innerHTML = "";
            axios.get(`http://localhost:5112/api/task/showuser`)
            .then(res => {
                const users = res.data;
                Object.keys(users).forEach(key => {
                const u = users[key];
                const udiv = document.createElement("div");
                udiv.id = "innerusers";
                udiv.innerHTML = `<div id="usersinfo">
                <p>${u.name}<p> </div>
                `;
                container.appendChild(udiv);
                });
            })
            .catch(err => {
                msg(err.response.data.msg);
            })
        }
        async function ClearUser() {
            try {
                await axios.delete(`http://localhost:5112/api/task/clearuser`)
            } catch (err) {
                msg(err.message);
            }
        }
        function msg(msg) {
            document.querySelectorAll(".result").forEach(test => {
                test.textContent = msg;
            })
        }
    </script>
</body>
</html>